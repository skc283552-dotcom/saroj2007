<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>My Accounting Pro</title>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<!-- jsPDF and jsPDF-AutoTable -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>

<style>
body { font-family: Arial, sans-serif; margin:0; padding:0; background:#f4f6f9; }
header { background:#2c3e50; color:#fff; text-align:center; padding:15px; font-size:24px; font-weight:bold; }
.dashboard { display:flex; flex-wrap:wrap; justify-content:center; gap:20px; margin:20px; }
.icon { background:#fff; border-radius:12px; box-shadow:0 2px 6px rgba(0,0,0,0.2); padding:20px; width:150px; text-align:center; cursor:pointer; transition:.3s; }
.icon:hover { background:#3498db; color:#fff; }
.icon span { font-size:40px; display:block; }
section { margin:20px; background:#fff; padding:20px; border-radius:12px; box-shadow:0 2px 6px rgba(0,0,0,0.1); display:none; }
table { width:100%; border-collapse:collapse; margin-top:10px; }
table, th, td { border:1px solid #ccc; }
th, td { padding:8px; text-align:center; }
button { padding:6px 12px; margin:2px; border:none; border-radius:6px; cursor:pointer; }
.edit { background:#f39c12; color:#fff; }
.delete { background:#e74c3c; color:#fff; }
.save { background:#27ae60; color:#fff; }
.balanceBox { display:flex; gap:20px; justify-content:center; margin:20px; }
.balanceCard { background:#fff; padding:15px; border-radius:12px; box-shadow:0 2px 6px rgba(0,0,0,0.1); text-align:center; width:150px; }
input, select { padding:6px; margin:4px; width:150px; }
</style>
</head>
<body>

<header>üìä My Accounting Pro</header>

<div class="dashboard" id="dashboard">
  <div class="icon" onclick="showSection('addTransaction')"><span>‚ûï</span>Add Transaction</div>
  <div class="icon" onclick="showSection('ledger')"><span>üìí</span>Ledger</div>
  <div class="icon" onclick="showSection('journal')"><span>üìù</span>Journal</div>
  <div class="icon" onclick="showSection('allTransactions')"><span>üìÇ</span>All Transactions</div>
  <div class="icon" onclick="downloadPDF('all')"><span>üìë</span>Download PDF</div>
</div>

<div class="balanceBox">
  <div class="balanceCard"><h3>Cash</h3><p id="cashBalance">0</p></div>
  <div class="balanceCard"><h3>Bank</h3><p id="bankBalance">0</p></div>
  <div class="balanceCard"><h3>eSewa</h3><p id="esewaBalance">0</p></div>
  <div class="balanceCard"><h3>Total</h3><p id="totalBalance">0</p></div>
</div>

<!-- Add Transaction -->
<section id="addTransaction">
  <h2>Add Transaction</h2>
  <input type="text" id="tname" placeholder="Name">
  <input type="number" id="tamount" placeholder="Amount">
  <select id="ttype">
    <option value="Cash">Cash</option>
    <option value="Bank">Bank</option>
    <option value="eSewa">eSewa</option>
  </select>
  <select id="ttCategory">
    <option value="Income">Income</option>
    <option value="Expense">Expense</option>
  </select>
  <input type="text" id="tdesc" placeholder="Description">
  <input type="date" id="tdate">
  <button class="save" onclick="addTransaction()">Save</button>
  <button onclick="showSection('dashboard')">‚¨Ö Back</button>
</section>

<!-- Ledger -->
<section id="ledger">
  <h2>Ledger</h2>
  <input type="text" id="searchLedger" placeholder="Search by Name">
  <input type="date" id="searchLedgerDate">
  <select id="ledgerAccount">
    <option value="">All Accounts</option>
    <option value="Cash">Cash</option>
    <option value="Bank">Bank</option>
    <option value="eSewa">eSewa</option>
  </select>
  <button onclick="searchLedgerFn()">Search</button>
  <button onclick="downloadPDF('ledger')">Download PDF</button>
  <div id="ledgerData"></div>
  <button onclick="showSection('dashboard')">‚¨Ö Back</button>
</section>

<!-- Journal -->
<section id="journal">
  <h2>Journal</h2>
  <div id="journalData"></div>
  <button onclick="showSection('dashboard')">‚¨Ö Back</button>
</section>

<!-- All Transactions -->
<section id="allTransactions">
  <h2>All Transactions</h2>
  <div id="allData"></div>
  <button onclick="showSection('dashboard')">‚¨Ö Back</button>
</section>

<!-- Edit Transaction -->
<section id="editTransaction">
  <h2>Edit Transaction</h2>
  <input type="hidden" id="editId">
  <input type="text" id="editName" placeholder="Name">
  <input type="number" id="editAmount" placeholder="Amount">
  <select id="editType">
    <option value="Cash">Cash</option>
    <option value="Bank">Bank</option>
    <option value="eSewa">eSewa</option>
  </select>
  <select id="editCategory">
    <option value="Income">Income</option>
    <option value="Expense">Expense</option>
  </select>
  <input type="text" id="editDesc" placeholder="Description">
  <input type="date" id="editDate">
  <button class="save" onclick="updateTransaction()">Update</button>
  <button onclick="showSection('ledger')">‚¨Ö Back</button>
</section>

<script>
// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyBgScLw0UPPs0t2KYulnCAIcvk6vw6ay18",
  authDomain: "data-d6493.firebaseapp.com",
  databaseURL: "https://data-d6493-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "data-d6493",
  storageBucket: "data-d6493.firebasestorage.app",
  messagingSenderId: "628882897413",
  appId: "1:628882897413:web:a2f4bd770457c71a427a6c",
  measurementId: "G-WE23QDWD33"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

function showSection(id){
  document.querySelectorAll('section').forEach(s=>s.style.display='none');
  if(id==='dashboard'){ document.getElementById('dashboard').style.display='flex'; }
  else{ document.getElementById('dashboard').style.display='none'; document.getElementById(id).style.display='block'; }
}

// Add Transaction
function addTransaction(){
  const name=document.getElementById('tname').value;
  const amount=parseFloat(document.getElementById('tamount').value);
  const type=document.getElementById('ttype').value;
  const category=document.getElementById('ttCategory').value;
  const desc=document.getElementById('tdesc').value;
  const date=document.getElementById('tdate').value || new Date().toISOString().slice(0,10);
  if(!name || !amount){ alert('Fill all fields'); return; }
  const newRef=db.ref('transactions').push();
  newRef.set({id:newRef.key,name,amount,type,category,desc,date});
  document.getElementById('tname').value=''; 
  document.getElementById('tamount').value=''; 
  document.getElementById('tdesc').value=''; 
  document.getElementById('tdate').value='';
}

// Real-time Data Render
db.ref('transactions').on('value', snapshot=>{
  const data=snapshot.val()||{};
  renderLedger(data);
  renderJournal(data);
  renderAll(data);
});

// Calculate balances
function calculateBalances(data){
  let balances={Cash:0,Bank:0,eSewa:0};
  for(let id in data){
    const t=data[id];
    const amt=(t.category==='Income'? t.amount : -t.amount);
    balances[t.type]+=amt;
  }
  balances.Total = (balances.Cash||0)+(balances.Bank||0)+(balances.eSewa||0);
  return balances;
}

function renderLedger(data){
  let html="<table><tr><th>Name</th><th>Amount</th><th>Category</th><th>Type</th><th>Description</th><th>Date</th><th>Balance</th><th>Action</th></tr>";
  let balances={Cash:0,Bank:0,eSewa:0};
  for(let id in data){
    const t=data[id];
    const amt=(t.category==='Income'? t.amount : -t.amount);
    balances[t.type]+=amt;
    const totalBalance=(balances.Cash||0)+(balances.Bank||0)+(balances.eSewa||0);
    html+=`<tr>
      <td>${t.name}</td><td>${t.amount}</td><td>${t.category}</td><td>${t.type}</td><td>${t.desc}</td><td>${t.date}</td><td>${totalBalance}</td>
      <td>
        <button class='edit' onclick="editTransaction('${id}')">Edit</button>
        <button class='delete' onclick="deleteTransaction('${id}')">Delete</button>
      </td>
    </tr>`;
  }
  html+="</table>"; document.getElementById('ledgerData').innerHTML=html;
  const b=calculateBalances(data);
  document.getElementById('cashBalance').innerText=b.Cash;
  document.getElementById('bankBalance').innerText=b.Bank;
  document.getElementById('esewaBalance').innerText=b.eSewa;
  document.getElementById('totalBalance').innerText=b.Total;
}

// Render Journal
function renderJournal(data){
  let html="<table><tr><th>Date</th><th>Name</th><th>Category</th><th>Type</th><th>Description</th><th>Amount</th></tr>";
  for(let id in data){
    const t=data[id];
    html+=`<tr><td>${t.date}</td><td>${t.name}</td><td>${t.category}</td><td>${t.type}</td><td>${t.desc}</td><td>${t.amount}</td></tr>`;
  }
  html+="</table>"; document.getElementById('journalData').innerHTML=html;
}

// Render All Transactions
function renderAll(data){
  let html="<table><tr><th>Name</th><th>Amount</th><th>Category</th><th>Type</th><th>Description</th><th>Date</th><th>Balance</th><th>Action</th></tr>";
  let balances={Cash:0,Bank:0,eSewa:0};
  for(let id in data){
    const t=data[id];
    const amt=(t.category==='Income'? t.amount : -t.amount);
    balances[t.type]+=amt;
    const totalBalance=(balances.Cash||0)+(balances.Bank||0)+(balances.eSewa||0);
    html+=`<tr>
      <td>${t.name}</td><td>${t.amount}</td><td>${t.category}</td><td>${t.type}</td><td>${t.desc}</td><td>${t.date}</td><td>${totalBalance}</td>
      <td>
        <button class='edit' onclick="editTransaction('${id}')">Edit</button>
        <button class='delete' onclick="deleteTransaction('${id}')">Delete</button>
      </td>
    </tr>`;
  }
  html+="</table>"; document.getElementById('allData').innerHTML=html;
}

// Delete Transaction
function deleteTransaction(id){
  if(confirm('Delete this transaction?')){
    db.ref('transactions/'+id).remove()
    .then(()=> alert("Transaction deleted ‚úÖ"))
    .catch(err => alert("Error deleting: " + err.message));
  }
}

// Edit Transaction
function editTransaction(id){
  db.ref('transactions/'+id).once('value',snap=>{
    const t = snap.val();
    document.getElementById("editId").value = id;
    document.getElementById("editName").value = t.name;
    document.getElementById("editAmount").value = t.amount;
    document.getElementById("editType").value = t.type;
    document.getElementById("editCategory").value = t.category;
    document.getElementById("editDesc").value = t.desc;
    document.getElementById("editDate").value = t.date;
    showSection('editTransaction');
  });
}

// Update Transaction
function updateTransaction(){
  const id = document.getElementById("editId").value;
  const updated = {
    name: document.getElementById("editName").value,
    amount: parseFloat(document.getElementById("editAmount").value),
    type: document.getElementById("editType").value,
    category: document.getElementById("editCategory").value,
    desc: document.getElementById("editDesc").value,
    date: document.getElementById("editDate").value
  };
  if(!updated.name || isNaN(updated.amount)){
    alert("Please fill all fields correctly");
    return;
  }
  db.ref("transactions/"+id).update(updated)
  .then(()=> { alert("Transaction updated ‚úÖ"); showSection('ledger'); })
  .catch(err=> alert("Update failed: " + err.message));
}

// Search Ledger & update balances dynamically
function searchLedgerFn(){
  const name=document.getElementById('searchLedger').value.toLowerCase();
  const date=document.getElementById('searchLedgerDate').value;
  const accountFilter=document.getElementById('ledgerAccount').value;
  
  db.ref('transactions').once('value',snap=>{
    const data=snap.val()||{};
    let html="<table><tr><th>Name</th><th>Amount</th><th>Category</th><th>Type</th><th>Description</th><th>Date</th><th>Balance</th></tr>";
    let balances={Cash:0,Bank:0,eSewa:0};
    for(let id in data){
      const t=data[id];
      if(accountFilter && t.type!==accountFilter) continue;
      if(!name || t.name.toLowerCase().includes(name)){
        if(!date || t.date===date){
          const amt=(t.category==='Income'? t.amount : -t.amount);
          balances[t.type]+=amt;
          const totalBalance=(balances.Cash||0)+(balances.Bank||0)+(balances.eSewa||0);
          html+=`<tr>
            <td>${t.name}</td><td>${t.amount}</td><td>${t.category}</td><td>${t.type}</td><td>${t.desc}</td><td>${t.date}</td><td>${totalBalance}</td>
          </tr>`;
        }
      }
    }
    html+="</table>";
    document.getElementById('ledgerData').innerHTML=html;
    const b = calculateBalancesFiltered(data, name, date, accountFilter);
    document.getElementById('cashBalance').innerText = b.Cash;
    document.getElementById('bankBalance').innerText = b.Bank;
    document.getElementById('esewaBalance').innerText = b.eSewa;
    document.getElementById('totalBalance').innerText = b.Total;
  });
}

// Filtered balances
function calculateBalancesFiltered(data, name='', date='', accountFilter=''){
  let balances={Cash:0,Bank:0,eSewa:0};
  for(let id in data){
    const t=data[id];
    if(accountFilter && t.type!==accountFilter) continue;
    if(name && !t.name.toLowerCase().includes(name)) continue;
    if(date && t.date!==date) continue;
    const amt = (t.category==='Income'? t.amount : -t.amount);
    balances[t.type]+=amt;
  }
  balances.Total = (balances.Cash||0)+(balances.Bank||0)+(balances.eSewa||0);
  return balances;
}

// PDF download (all or filtered ledger)
function downloadPDF(type='all'){
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF('p', 'pt', 'a4');
  const leftMargin = 40;
  const topMargin = 60;
  const head = [['Date', 'Name', 'Amount', 'Type', 'Category', 'Description', 'Running Balance']];
  
  db.ref('transactions').once('value', snap => {
    const data = snap.val() || {};
    let entries = Object.values(data);
    let title = "All Transactions";

    if(type==='ledger'){
      const accountFilter = document.getElementById('ledgerAccount').value;
      const nameFilter = document.getElementById('searchLedger').value.toLowerCase();
      const dateFilter = document.getElementById('searchLedgerDate').value;
      title = `Ledger Report - ${accountFilter || "All Accounts"}`;
      entries = entries.filter(t=>{
        if(accountFilter && t.type!==accountFilter) return false;
        if(nameFilter && !t.name.toLowerCase().includes(nameFilter)) return false;
        if(dateFilter && t.date!==dateFilter) return false;
        return true;
      });
    }

    entries.sort((a,b)=> new Date(a.date) - new Date(b.date));
    let balances = { Cash:0, Bank:0, eSewa:0 };
    const body = entries.map(t => {
      const amt = (t.category === 'Income' ? Number(t.amount) : -Number(t.amount));
      balances[t.type] = (balances[t.type] || 0) + amt;
      const running = (balances.Cash||0)+(balances.Bank||0)+(balances.eSewa||0);
      return [
        t.date, t.name, Number(t.amount).toFixed(2), t.type, t.category, t.desc, Number(running).toFixed(2)
      ];
    });

    // PDF title & summary
    doc.setFontSize(14);
    doc.text(title, leftMargin, topMargin - 10);
    if(type==='ledger'){
      doc.setFontSize(12);
      doc.text(`Cash: ${balances.Cash.toFixed(2)} | Bank: ${balances.Bank.toFixed(2)} | eSewa: ${balances.eSewa.toFixed(2)} | Total: ${(balances.Cash+balances.Bank+balances.eSewa).toFixed(2)}`, leftMargin, topMargin-30);
    }

    doc.autoTable({
      head: head,
      body: body,
      startY: topMargin + 10,
      margin: { left: leftMargin, right: 40 },
      styles: { fontSize: 10, cellPadding: 6 },
      headStyles: { fillColor: [41,128,185], textColor: 255, halign: 'center' },
      columnStyles: { 5:{cellWidth:150}, 2:{halign:'right'}, 6:{halign:'right'} }
    });

    doc.save(type==='all'?'transactions_table.pdf':'ledger_report.pdf');
  });
}
</script>

</body>
</html>
