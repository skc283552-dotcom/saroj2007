<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>My Accounting Pro</title>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<!-- jsPDF and jsPDF-AutoTable -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
body { font-family: Arial, sans-serif; margin:0; padding:0; background:#f4f6f9; }
header { background:#2c3e50; color:#fff; text-align:center; padding:15px; font-size:24px; font-weight:bold; }
.dashboard { display:flex; flex-wrap:wrap; justify-content:center; gap:20px; margin:20px; }
.icon { background:#fff; border-radius:12px; box-shadow:0 2px 6px rgba(0,0,0,0.2); padding:20px; width:150px; text-align:center; cursor:pointer; transition:.3s; }
.icon:hover { background:#3498db; color:#fff; }
.icon span { font-size:40px; display:block; }
section { margin:20px; background:#fff; padding:20px; border-radius:12px; box-shadow:0 2px 6px rgba(0,0,0,0.1); display:none; }
table { width:100%; border-collapse:collapse; margin-top:10px; }
table, th, td { border:1px solid #ccc; }
th, td { padding:8px; text-align:center; }
button { padding:6px 12px; margin:2px; border:none; border-radius:6px; cursor:pointer; }
.edit { background:#f39c12; color:#fff; }
.delete { background:#e74c3c; color:#fff; }
.save { background:#27ae60; color:#fff; }
.balanceBox { display:flex; gap:20px; justify-content:center; margin:20px; }
.balanceCard { background:#fff; padding:15px; border-radius:12px; box-shadow:0 2px 6px rgba(0,0,0,0.1); text-align:center; width:150px; }
input, select { padding:6px; margin:4px; width:150px; }

/* Debtors System Styles */
.debtors-container {
  display: flex;
  margin-top: 20px;
}

.debtors-sidebar {
  width: 220px;
  background: #34495e;
  color: white;
  padding: 15px;
  border-radius: 8px;
  margin-right: 20px;
}

.debtors-sidebar h3 {
  text-align: center;
  margin-bottom: 20px;
}

.debtors-sidebar button {
  display: block;
  width: 90%;
  margin: 10px auto;
  padding: 10px;
  background: #1abc9c;
  color: white;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-size: 15px;
}

.debtors-sidebar button:hover {
  background: #16a085;
}

.debtors-content {
  flex: 1;
}

.debtors-section {
  display: none;
}

.debtors-table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 20px;
  background: white;
  border-radius: 8px;
  overflow: hidden;
  box-shadow: 0 3px 8px rgba(0,0,0,0.1);
}

.debtors-table th, .debtors-table td {
  padding: 12px;
  text-align: left;
  border-bottom: 1px solid #ddd;
}

.debtors-table th {
  background: #1abc9c;
  color: white;
}

.debtors-actions button {
  background: none;
  border: none;
  cursor: pointer;
  font-size: 18px;
  margin: 0 5px;
}

.debtors-actions .edit { color: #2980b9; }
.debtors-actions .delete { color: #e74c3c; }

/* Enhanced Debtors Management Styles */
.debtors-management {
  width: 100%;
}

.debtors-management input, .debtors-management select {
  margin: 5px;
  padding: 8px;
  width: 180px;
}

.debtors-management button {
  margin: 5px;
}

.debtors-management table {
  margin-top: 20px;
}

.debtors-management th {
  background: #3498db;
  color: white;
  padding: 10px;
}

.debtors-management td {
  padding: 8px;
}

.debtors-management .pdf-options {
  margin-top: 20px;
  padding: 15px;
  background: #f8f9fa;
  border-radius: 8px;
}

.debtors-management .pdf-options button {
  margin: 5px;
}
</style>
</head>
<body>

<header>üìä My Accounting Pro</header>

<div class="dashboard" id="dashboard">
  <div class="icon" onclick="showSection('addTransaction')"><span>‚ûï</span>Add Transaction</div>
  <div class="icon" onclick="showSection('ledger')"><span>üìí</span>Ledger</div>
  <div class="icon" onclick="showSection('journal')"><span>üìù</span>Journal</div>
  <div class="icon" onclick="showSection('allTransactions')"><span>üìÇ</span>All Transactions</div>
  <div class="icon" onclick="showSection('debtorsSystem')"><span>üë•</span>Debtors System</div>
  <div class="icon" onclick="downloadPDF('all')"><span>üìë</span>Download PDF</div>
</div>

<div class="balanceBox">
  <div class="balanceCard"><h3>Cash</h3><p id="cashBalance">0</p></div>
  <div class="balanceCard"><h3>Bank</h3><p id="bankBalance">0</p></div>
  <div class="balanceCard"><h3>eSewa</h3><p id="esewaBalance">0</p></div>
  <div class="balanceCard"><h3>Total</h3><p id="totalBalance">0</p></div>
</div>

<!-- Add Transaction -->
<section id="addTransaction">
  <h2>Add Transaction</h2>
  <input type="text" id="tname" placeholder="Name">
  <input type="number" id="tamount" placeholder="Amount">
  <select id="ttype">
    <option value="Cash">Cash</option>
    <option value="Bank">Bank</option>
    <option value="eSewa">eSewa</option>
  </select>
  <select id="ttCategory">
    <option value="Income">Income</option>
    <option value="Expense">Expense</option>
  </select>
  <input type="text" id="tdesc" placeholder="Description">
  <input type="date" id="tdate">
  <button class="save" onclick="addTransaction()">Save</button>
  <button onclick="showSection('dashboard')">‚¨Ö Back</button>
</section>

<!-- Ledger -->
<section id="ledger">
  <h2>Ledger</h2>
  <input type="text" id="searchLedger" placeholder="Search by Name">
  <input type="date" id="searchLedgerDate">
  <select id="ledgerAccount">
    <option value="">All Accounts</option>
    <option value="Cash">Cash</option>
    <option value="Bank">Bank</option>
    <option value="eSewa">eSewa</option>
  </select>
  <button onclick="searchLedgerFn()">Search</button>
  <button onclick="downloadPDF('ledger')">Download PDF</button>
  <div id="ledgerData"></div>
  <button onclick="showSection('dashboard')">‚¨Ö Back</button>
</section>

<!-- Journal -->
<section id="journal">
  <h2>Journal</h2>
  <div id="journalData"></div>
  <button onclick="showSection('dashboard')">‚¨Ö Back</button>
</section>

<!-- All Transactions -->
<section id="allTransactions">
  <h2>All Transactions</h2>
  <div id="allData"></div>
  <button onclick="showSection('dashboard')">‚¨Ö Back</button>
</section>

<!-- Edit Transaction -->
<section id="editTransaction">
  <h2>Edit Transaction</h2>
  <input type="hidden" id="editId">
  <input type="text" id="editName" placeholder="Name">
  <input type="number" id="editAmount" placeholder="Amount">
  <select id="editType">
    <option value="Cash">Cash</option>
    <option value="Bank">Bank</option>
    <option value="eSewa">eSewa</option>
  </select>
  <select id="editCategory">
    <option value="Income">Income</option>
    <option value="Expense">Expense</option>
  </select>
  <input type="text" id="editDesc" placeholder="Description">
  <input type="date" id="editDate">
  <button class="save" onclick="updateTransaction()">Update</button>
  <button onclick="showSection('ledger')">‚¨Ö Back</button>
</section>

<!-- Debtors System -->
<section id="debtorsSystem">
  <h2><i class="fas fa-users"></i> Debtors Management System</h2>
  
  <div class="debtors-management">
    <!-- Debtors Management Section -->
    <div id="debtorsManagementSection">
      <h3>Debtors Management</h3>
      <input type="text" id="debtorName" placeholder="Debtor Name">
      <input type="text" id="debtorPhone" placeholder="Phone">
      <button class="save" onclick="addDebtor()"><i class="fa fa-plus"></i> Add Debtor</button>
      <div id="debtorList"></div>
    </div>
    
    <!-- Transactions per Debtor Section -->
    <div id="transactionsPerDebtorSection" style="display:none; margin-top: 30px;">
      <h3>Transactions per Debtor</h3>
      <select id="selectDebtor" onchange="loadDebtorTransactions()"></select><br>
      <input type="text" id="txnDesc" placeholder="Description">
      <input type="number" id="txnAmount" placeholder="Amount">
      <select id="txnType">
        <option value="Income">Income</option>
        <option value="Expense">Expense</option>
      </select>
      <select id="txnPayment">
        <option value="Cash">Cash</option>
        <option value="Bank">Bank</option>
        <option value="eSewa">eSewa</option>
        <option value="Mobile Banking">Mobile Banking</option>
      </select>
      <input type="date" id="txnDate">
      <button class="save" onclick="addDebtorTransaction()"><i class="fa fa-plus"></i> Add Transaction</button>
      <br><input type="text" id="searchTxn" placeholder="Search by description" onkeyup="loadDebtorTransactions()">
      <div id="debtorTxnList"></div>
    </div>
    
    <!-- PDF Reports Section -->
    <div id="pdfReportsSection" style="display:none; margin-top: 30px;">
      <h3>PDF Reports</h3>
      <div class="pdf-options">
        <select id="pdfDebtor"></select>
        <button onclick="downloadDebtorPDF()"><i class="fa fa-file-pdf"></i> Debtor PDF</button>
        <button onclick="downloadAllDebtorsPDF()"><i class="fa fa-file-pdf"></i> All Transactions</button>
        <button onclick="downloadTypePDF('Income')"><i class="fa fa-file-pdf"></i> Income Only</button>
        <button onclick="downloadTypePDF('Expense')"><i class="fa fa-file-pdf"></i> Expense Only</button>
      </div>
    </div>
    
    <!-- Navigation Buttons -->
    <div style="margin-top: 20px;">
      <button onclick="showDebtorsSection('management')">üìã Debtors</button>
      <button onclick="showDebtorsSection('transactions')">üí∞ Transactions</button>
      <button onclick="showDebtorsSection('reports')">üìë PDF Reports</button>
      <button onclick="showSection('dashboard')">‚¨Ö Back to Dashboard</button>
    </div>
  </div>
</section>

<script>
// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyBgScLw0UPPs0t2KYulnCAIcvk6vw6ay18",
  authDomain: "data-d6493.firebaseapp.com",
  databaseURL: "https://data-d6493-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "data-d6493",
  storageBucket: "data-d6493.firebasestorage.app",
  messagingSenderId: "628882897413",
  appId: "1:628882897413:web:a2f4bd770457c71a427a6c",
  measurementId: "G-WE23QDWD33"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

function showSection(id){
  document.querySelectorAll('section').forEach(s=>s.style.display='none');
  if(id==='dashboard'){ 
    document.getElementById('dashboard').style.display='flex'; 
  }
  else{ 
    document.getElementById('dashboard').style.display='none'; 
    document.getElementById(id).style.display='block'; 
    
    // Initialize debtors system if shown
    if(id === 'debtorsSystem') {
      showDebtorsSection('management');
      loadDebtors();
    }
  }
}

// ========== ORIGINAL ACCOUNTING FUNCTIONS ==========

// Add Transaction
function addTransaction(){
  const name=document.getElementById('tname').value;
  const amount=parseFloat(document.getElementById('tamount').value);
  const type=document.getElementById('ttype').value;
  const category=document.getElementById('ttCategory').value;
  const desc=document.getElementById('tdesc').value;
  const date=document.getElementById('tdate').value || new Date().toISOString().slice(0,10);
  if(!name || !amount){ alert('Fill all fields'); return; }
  const newRef=db.ref('transactions').push();
  newRef.set({id:newRef.key,name,amount,type,category,desc,date});
  document.getElementById('tname').value=''; 
  document.getElementById('tamount').value=''; 
  document.getElementById('tdesc').value=''; 
  document.getElementById('tdate').value='';
}

// Real-time Data Render
db.ref('transactions').on('value', snapshot=>{
  const data=snapshot.val()||{};
  renderLedger(data);
  renderJournal(data);
  renderAll(data);
});

// Calculate balances
function calculateBalances(data){
  let balances={Cash:0,Bank:0,eSewa:0};
  for(let id in data){
    const t=data[id];
    const amt=(t.category==='Income'? t.amount : -t.amount);
    balances[t.type]+=amt;
  }
  balances.Total = (balances.Cash||0)+(balances.Bank||0)+(balances.eSewa||0);
  return balances;
}

function renderLedger(data){
  let html="<table><tr><th>Name</th><th>Amount</th><th>Category</th><th>Type</th><th>Description</th><th>Date</th><th>Balance</th><th>Action</th></tr>";
  let balances={Cash:0,Bank:0,eSewa:0};
  for(let id in data){
    const t=data[id];
    const amt=(t.category==='Income'? t.amount : -t.amount);
    balances[t.type]+=amt;
    const totalBalance=(balances.Cash||0)+(balances.Bank||0)+(balances.eSewa||0);
    html+=`<tr>
      <td>${t.name}</td><td>${t.amount}</td><td>${t.category}</td><td>${t.type}</td><td>${t.desc}</td><td>${t.date}</td><td>${totalBalance}</td>
      <td>
        <button class='edit' onclick="editTransaction('${id}')">Edit</button>
        <button class='delete' onclick="deleteTransaction('${id}')">Delete</button>
      </td>
    </tr>`;
  }
  html+="</table>"; document.getElementById('ledgerData').innerHTML=html;
  const b=calculateBalances(data);
  document.getElementById('cashBalance').innerText=b.Cash;
  document.getElementById('bankBalance').innerText=b.Bank;
  document.getElementById('esewaBalance').innerText=b.eSewa;
  document.getElementById('totalBalance').innerText=b.Total;
}

// Render Journal
function renderJournal(data){
  let html="<table><tr><th>Date</th><th>Name</th><th>Category</th><th>Type</th><th>Description</th><th>Amount</th></tr>";
  for(let id in data){
    const t=data[id];
    html+=`<tr><td>${t.date}</td><td>${t.name}</td><td>${t.category}</td><td>${t.type}</td><td>${t.desc}</td><td>${t.amount}</td></tr>`;
  }
  html+="</table>"; document.getElementById('journalData').innerHTML=html;
}

// Render All Transactions
function renderAll(data){
  let html="<table><tr><th>Name</th><th>Amount</th><th>Category</th><th>Type</th><th>Description</th><th>Date</th><th>Balance</th><th>Action</th></tr>";
  let balances={Cash:0,Bank:0,eSewa:0};
  for(let id in data){
    const t=data[id];
    const amt=(t.category==='Income'? t.amount : -t.amount);
    balances[t.type]+=amt;
    const totalBalance=(balances.Cash||0)+(balances.Bank||0)+(balances.eSewa||0);
    html+=`<tr>
      <td>${t.name}</td><td>${t.amount}</td><td>${t.category}</td><td>${t.type}</td><td>${t.desc}</td><td>${t.date}</td><td>${totalBalance}</td>
      <td>
        <button class='edit' onclick="editTransaction('${id}')">Edit</button>
        <button class='delete' onclick="deleteTransaction('${id}')">Delete</button>
      </td>
    </tr>`;
  }
  html+="</table>"; document.getElementById('allData').innerHTML=html;
}

// Delete Transaction
function deleteTransaction(id){
  if(confirm('Delete this transaction?')){
    db.ref('transactions/'+id).remove()
    .then(()=> alert("Transaction deleted ‚úÖ"))
    .catch(err => alert("Error deleting: " + err.message));
  }
}

// Edit Transaction
function editTransaction(id){
  db.ref('transactions/'+id).once('value',snap=>{
    const t = snap.val();
    document.getElementById("editId").value = id;
    document.getElementById("editName").value = t.name;
    document.getElementById("editAmount").value = t.amount;
    document.getElementById("editType").value = t.type;
    document.getElementById("editCategory").value = t.category;
    document.getElementById("editDesc").value = t.desc;
    document.getElementById("editDate").value = t.date;
    showSection('editTransaction');
  });
}

// Update Transaction
function updateTransaction(){
  const id = document.getElementById("editId").value;
  const updated = {
    name: document.getElementById("editName").value,
    amount: parseFloat(document.getElementById("editAmount").value),
    type: document.getElementById("editType").value,
    category: document.getElementById("editCategory").value,
    desc: document.getElementById("editDesc").value,
    date: document.getElementById("editDate").value
  };
  if(!updated.name || isNaN(updated.amount)){
    alert("Please fill all fields correctly");
    return;
  }
  db.ref("transactions/"+id).update(updated)
  .then(()=> { alert("Transaction updated ‚úÖ"); showSection('ledger'); })
  .catch(err=> alert("Update failed: " + err.message));
}

// Search Ledger & update balances dynamically
function searchLedgerFn(){
  const name=document.getElementById('searchLedger').value.toLowerCase();
  const date=document.getElementById('searchLedgerDate').value;
  const accountFilter=document.getElementById('ledgerAccount').value;
  
  db.ref('transactions').once('value',snap=>{
    const data=snap.val()||{};
    let html="<table><tr><th>Name</th><th>Amount</th><th>Category</th><th>Type</th><th>Description</th><th>Date</th><th>Balance</th></tr>";
    let balances={Cash:0,Bank:0,eSewa:0};
    for(let id in data){
      const t=data[id];
      if(accountFilter && t.type!==accountFilter) continue;
      if(!name || t.name.toLowerCase().includes(name)){
        if(!date || t.date===date){
          const amt=(t.category==='Income'? t.amount : -t.amount);
          balances[t.type]+=amt;
          const totalBalance=(balances.Cash||0)+(balances.Bank||0)+(balances.eSewa||0);
          html+=`<tr>
            <td>${t.name}</td><td>${t.amount}</td><td>${t.category}</td><td>${t.type}</td><td>${t.desc}</td><td>${t.date}</td><td>${totalBalance}</td>
          </tr>`;
        }
      }
    }
    html+="</table>";
    document.getElementById('ledgerData').innerHTML=html;
    const b = calculateBalancesFiltered(data, name, date, accountFilter);
    document.getElementById('cashBalance').innerText = b.Cash;
    document.getElementById('bankBalance').innerText = b.Bank;
    document.getElementById('esewaBalance').innerText = b.eSewa;
    document.getElementById('totalBalance').innerText = b.Total;
  });
}

// Filtered balances
function calculateBalancesFiltered(data, name='', date='', accountFilter=''){
  let balances={Cash:0,Bank:0,eSewa:0};
  for(let id in data){
    const t=data[id];
    if(accountFilter && t.type!==accountFilter) continue;
    if(name && !t.name.toLowerCase().includes(name)) continue;
    if(date && t.date!==date) continue;
    const amt = (t.category==='Income'? t.amount : -t.amount);
    balances[t.type]+=amt;
  }
  balances.Total = (balances.Cash||0)+(balances.Bank||0)+(balances.eSewa||0);
  return balances;
}

// PDF download (all or filtered ledger)
function downloadPDF(type='all'){
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF('p', 'pt', 'a4');
  const leftMargin = 40;
  const topMargin = 60;
  const head = [['Date', 'Name', 'Amount', 'Type', 'Category', 'Description', 'Running Balance']];
  
  db.ref('transactions').once('value', snap => {
    const data = snap.val() || {};
    let entries = Object.values(data);
    let title = "All Transactions";

    if(type==='ledger'){
      const accountFilter = document.getElementById('ledgerAccount').value;
      const nameFilter = document.getElementById('searchLedger').value.toLowerCase();
      const dateFilter = document.getElementById('searchLedgerDate').value;
      title = `Ledger Report - ${accountFilter || "All Accounts"}`;
      entries = entries.filter(t=>{
        if(accountFilter && t.type!==accountFilter) return false;
        if(nameFilter && !t.name.toLowerCase().includes(nameFilter)) return false;
        if(dateFilter && t.date!==dateFilter) return false;
        return true;
      });
    }

    entries.sort((a,b)=> new Date(a.date) - new Date(b.date));
    let balances = { Cash:0, Bank:0, eSewa:0 };
    const body = entries.map(t => {
      const amt = (t.category === 'Income' ? Number(t.amount) : -Number(t.amount));
      balances[t.type] = (balances[t.type] || 0) + amt;
      const running = (balances.Cash||0)+(balances.Bank||0)+(balances.eSewa||0);
      return [
        t.date, t.name, Number(t.amount).toFixed(2), t.type, t.category, t.desc, Number(running).toFixed(2)
      ];
    });

    // PDF title & summary
    doc.setFontSize(14);
    doc.text(title, leftMargin, topMargin - 10);
    if(type==='ledger'){
      doc.setFontSize(12);
      doc.text(`Cash: ${balances.Cash.toFixed(2)} | Bank: ${balances.Bank.toFixed(2)} | eSewa: ${balances.eSewa.toFixed(2)} | Total: ${(balances.Cash+balances.Bank+balances.eSewa).toFixed(2)}`, leftMargin, topMargin-30);
    }

    doc.autoTable({
      head: head,
      body: body,
      startY: topMargin + 10,
      margin: { left: leftMargin, right: 40 },
      styles: { fontSize: 10, cellPadding: 6 },
      headStyles: { fillColor: [41,128,185], textColor: 255, halign: 'center' },
      columnStyles: { 5:{cellWidth:150}, 2:{halign:'right'}, 6:{halign:'right'} }
    });

    doc.save(type==='all'?'transactions_table.pdf':'ledger_report.pdf');
  });
}

// ========== DEBTORS MANAGEMENT FUNCTIONS ==========

function showDebtorsSection(section) {
  document.getElementById('debtorsManagementSection').style.display = (section === 'management') ? 'block' : 'none';
  document.getElementById('transactionsPerDebtorSection').style.display = (section === 'transactions') ? 'block' : 'none';
  document.getElementById('pdfReportsSection').style.display = (section === 'reports') ? 'block' : 'none';
}

function addDebtor(){
  const name=document.getElementById('debtorName').value;
  const phone=document.getElementById('debtorPhone').value;
  if(!name){alert('Enter debtor name'); return;}
  const ref=db.ref('debtors').push();
  ref.set({name, phone});
  document.getElementById('debtorName').value='';
  document.getElementById('debtorPhone').value='';
}

function loadDebtors(){
  db.ref('debtors').on('value', snap=>{
    const data=snap.val()||{};
    let html='<table><tr><th>Name</th><th>Phone</th><th>Action</th></tr>';
    let debtorSelect='<option value="">Select Debtor</option>';
    let pdfDebtorSelect='<option value="">Select Debtor</option>';
    
    for(let id in data){
      html+=`<tr><td>${data[id].name}</td><td>${data[id].phone||''}</td>
              <td><button class='delete' onclick="deleteDebtor('${id}')"><i class='fa fa-trash'></i></button></td></tr>`;
      debtorSelect+=`<option value='${id}'>${data[id].name}</option>`;
      pdfDebtorSelect+=`<option value='${id}'>${data[id].name}</option>`;
    }
    html+='</table>';
    document.getElementById('debtorList').innerHTML=html;
    document.getElementById('selectDebtor').innerHTML=debtorSelect;
    document.getElementById('pdfDebtor').innerHTML=pdfDebtorSelect;
  });
}

function deleteDebtor(id){
  if(confirm('Delete this debtor and all transactions?')){
    db.ref('debtors/'+id).remove();
  }
}

function addDebtorTransaction(){
  const debtorId=document.getElementById('selectDebtor').value;
  if(!debtorId){alert('Select debtor'); return;}
  const desc=document.getElementById('txnDesc').value;
  const amount=parseFloat(document.getElementById('txnAmount').value);
  const type=document.getElementById('txnType').value;
  const payment=document.getElementById('txnPayment').value;
  const date=document.getElementById('txnDate').value||new Date().toISOString().slice(0,10);
  if(!desc || !amount){alert('Fill all fields'); return;}
  const ref=db.ref('debtors/'+debtorId+'/transactions').push();
  ref.set({desc, amount, type, payment, date});
  document.getElementById('txnDesc').value='';
  document.getElementById('txnAmount').value='';
  document.getElementById('txnDate').value='';
}

function loadDebtorTransactions(){
  const debtorId=document.getElementById('selectDebtor').value;
  const search=document.getElementById('searchTxn').value.toLowerCase();
  if(!debtorId){document.getElementById('debtorTxnList').innerHTML=''; return;}
  db.ref('debtors/'+debtorId+'/transactions').once('value', snap=>{
    const data=snap.val()||{};
    let html='<table><tr><th>Date</th><th>Description</th><th>Amount</th><th>Type</th><th>Payment</th><th>Action</th></tr>';
    for(let id in data){
      if(data[id].desc.toLowerCase().includes(search)){
        html+=`<tr>
          <td>${data[id].date}</td>
          <td contenteditable='true' onBlur="updateTxn('${debtorId}','${id}','desc',this.innerText)">${data[id].desc}</td>
          <td contenteditable='true' onBlur="updateTxn('${debtorId}','${id}','amount',this.innerText)">${data[id].amount}</td>
          <td contenteditable='true' onBlur="updateTxn('${debtorId}','${id}','type',this.innerText)">${data[id].type}</td>
          <td contenteditable='true' onBlur="updateTxn('${debtorId}','${id}','payment',this.innerText)">${data[id].payment||''}</td>
          <td><button class='delete' onclick="deleteDebtorTxn('${debtorId}','${id}')"><i class='fa fa-trash'></i></button></td>
        </tr>`;
      }
    }
    html+='</table>';
    document.getElementById('debtorTxnList').innerHTML=html;
  });
}

function updateTxn(debtorId, txnId, field, value){
  db.ref(`debtors/${debtorId}/transactions/${txnId}/${field}`).set(value);
}

function deleteDebtorTxn(debtorId, txnId){
  if(confirm('Delete this transaction?')){
    db.ref('debtors/'+debtorId+'/transactions/'+txnId).remove().then(()=>loadDebtorTransactions());
  }
}

// PDF from reports section
function downloadDebtorPDF(){
  const debtorId=document.getElementById('pdfDebtor').value;
  if(!debtorId){alert('Select a debtor for PDF'); return;}
  db.ref('debtors/'+debtorId+'/transactions').once('value', snap=>{
    generateDebtorPDF(Object.values(snap.val()||{}), 'Debtor Transactions');
  });
}

function downloadAllDebtorsPDF(){
  db.ref('debtors').once('value', snap=>{
    let allTxns=[];
    const data=snap.val()||{};
    for(let d in data){ if(data[d].transactions){ allTxns.push(...Object.values(data[d].transactions)); } }
    generateDebtorPDF(allTxns,'All Debtor Transactions');
  });
}

function downloadTypePDF(type){
  db.ref('debtors').once('value', snap=>{
    let txns=[];
    const data=snap.val()||{};
    for(let d in data){ if(data[d].transactions){ txns.push(...Object.values(data[d].transactions).filter(t=>t.type===type)); } }
    generateDebtorPDF(txns, type+' Transactions');
  });
}

function generateDebtorPDF(entries,title){
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF('p','pt','a4');
  let body=[]; let balance=0;
  entries.forEach(t=>{
    const amt = t.type==='Income'? parseFloat(t.amount) : -parseFloat(t.amount);
    balance += amt;
    body.push([t.date,t.desc,t.amount,t.type,t.payment||'',balance.toFixed(2)]);
  });
  doc.setFontSize(14);
  doc.text(title+' Report', 40, 50);
  doc.autoTable({
    head:[['Date','Description','Amount','Type','Payment','Running Balance']],
    body:body,
    startY:70,
    styles:{fontSize:10,cellPadding:6},
    headStyles:{fillColor:[52,152,219],textColor:255,halign:'center'},
    columnStyles:{5:{halign:'right'}}
  });
  doc.save(title.replace(' ','_')+'.pdf');
}
</script>

</body>
</html>
