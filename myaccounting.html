<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>My Accounting Pro ‚Äî Final</title>

<!-- Firebase compat -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<!-- jsPDF + autoTable -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>

<style>
:root{--bg:#f4f6f9;--card:#fff;--accent:#2c3e50;--muted:#6b7280}
*{box-sizing:border-box}
body{font-family:Arial,Helvetica,sans-serif;margin:0;background:var(--bg);color:#111}
header{background:var(--accent);color:#fff;padding:14px;text-align:center;font-weight:700}
.container{padding:14px}
.dashboard{display:flex;flex-wrap:wrap;gap:12px;justify-content:center;margin:12px 0}
.tile{background:var(--card);width:140px;border-radius:10px;padding:12px;text-align:center;box-shadow:0 6px 18px rgba(2,6,23,0.06);cursor:pointer;user-select:none}
.tile:hover{transform:translateY(-6px)}
.tile .ico{font-size:26px;margin-bottom:6px}
.balances{display:flex;gap:12px;justify-content:center;margin:12px 0;flex-wrap:wrap}
.card{background:var(--card);padding:10px;border-radius:8px;min-width:120px;text-align:center;box-shadow:0 4px 14px rgba(2,6,23,0.04)}
section{display:none;background:var(--card);padding:16px;border-radius:10px;margin:12px;box-shadow:0 8px 24px rgba(2,6,23,0.04)}
h2{margin:0 0 12px}
.controls{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px;align-items:center}
input,select,textarea,button{padding:8px;border-radius:8px;border:1px solid #e2e8f0}
button{cursor:pointer}
.btn{background:var(--accent);color:white;border:none;padding:8px 10px;border-radius:8px}
.btn.ghost{background:transparent;color:var(--accent);border:1px solid var(--accent)}
.table-wrap{overflow:auto;max-height:56vh;border-radius:8px}
table{width:100%;border-collapse:collapse}
th,td{padding:8px;border-bottom:1px solid #e6eef8;text-align:left;font-size:14px}
th{background:#f8fbff;color:var(--muted);position:sticky;top:0}
.actions button{margin-right:6px;padding:6px 8px;border-radius:6px;border:none}
.edit{background:#f59e0b;color:white}
.del{background:#ef4444;color:white}
.small{font-size:13px;color:var(--muted)}
.autosuggest{width:300px}
.modal-backdrop{position:fixed;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,0.35);display:none;align-items:center;justify-content:center;z-index:1000}
.modal{background:white;padding:16px;border-radius:10px;min-width:320px;box-shadow:0 8px 30px rgba(0,0,0,0.3)}
@media(max-width:720px){ .tile{width:110px} .controls{flex-direction:column;align-items:stretch} .autosuggest{width:100%} .modal{width:92%} }
</style>
</head>
<body>
<header>üìä My Accounting Pro ‚Äî Final</header>

<div class="container">

  <!-- Dashboard (always visible) -->
  <div class="dashboard" id="dashboard">
    <div class="tile" data-target="addSection"><div class="ico">‚ûï</div><div>New Transaction</div></div>
    <div class="tile" data-target="ledgerSection"><div class="ico">üìí</div><div>Ledger</div></div>
    <div class="tile" data-target="journalSection"><div class="ico">üìù</div><div>Journal</div></div>
    <div class="tile" data-target="allSection"><div class="ico">üìÇ</div><div>All Transactions</div></div>
    <div class="tile" data-target="debtorsSection"><div class="ico">üí∞</div><div>Debtors</div></div>
    <div class="tile" data-target="creditorsSection"><div class="ico">üè¶</div><div>Creditors</div></div>
    <div class="tile" id="downloadAllPdfTile"><div class="ico">üìë</div><div>Download All PDF</div></div>
    <div class="tile" id="deleteAllTile"><div class="ico">üóëÔ∏è</div><div>Delete All</div></div>
  </div>

  <div class="balances" id="balancesRow">
    <div class="card"><div class="small">Cash</div><div id="balCash">0.00</div></div>
    <div class="card"><div class="small">Bank</div><div id="balBank">0.00</div></div>
    <div class="card"><div class="small">eSewa</div><div id="balEsewa">0.00</div></div>
    <div class="card"><div class="small">Total</div><div id="balTotal">0.00</div></div>
  </div>

  <!-- Add Transaction -->
  <section id="addSection">
    <h2>Add Transaction</h2>
    <div class="controls">
      <input id="inputName" class="autosuggest" placeholder="Account / Person name" list="namesDL" />
      <datalist id="namesDL"></datalist>
      <input id="inputAmount" type="number" placeholder="Amount (Rs)" />
      <select id="inputPayment"><option>Cash</option><option>Bank</option><option>eSewa</option></select>
      <select id="inputCategory"><option>Income</option><option>Expense</option></select>
      <input id="inputDate" type="date" />
      <input id="inputDesc" placeholder="Description / Remarks" />
      <button class="btn" id="btnSaveTx">Save</button>
      <button class="btn ghost" id="btnBackFromAdd">Back</button>
    </div>
    <div class="small">Start typing to see existing account suggestions.</div>
  </section>

  <!-- Ledger -->
  <section id="ledgerSection">
    <h2>Ledger</h2>
    <div class="controls">
      <input id="ledgerSearch" placeholder="Search account..." />
      <input id="ledgerDate" type="date" />
      <select id="ledgerAccount"><option value="">-- Select account --</option></select>
      <button class="btn" id="btnOpenLedger">Open Ledger</button>
      <button class="btn ghost" id="btnLedgerPDF">Download Ledger PDF</button>
      <button class="btn ghost" id="btnBackFromLedger">Back</button>
    </div>
    <div id="ledgerContent" class="table-wrap"></div>
  </section>

  <!-- Journal -->
  <section id="journalSection">
    <h2>Journal</h2>
    <div class="controls">
      <input id="journalSearch" placeholder="Search journal..." />
      <button class="btn ghost" id="btnBackFromJournal">Back</button>
    </div>
    <div id="journalTable" class="table-wrap"></div>
  </section>

  <!-- All Transactions -->
  <section id="allSection">
    <h2>All Transactions</h2>
    <div class="controls">
      <input id="allSearch" placeholder="Search name/desc..." />
      <input id="allDate" type="date" />
      <button class="btn ghost" id="btnAllPDF">Download PDF</button>
      <button class="btn ghost" id="btnBackFromAll">Back</button>
    </div>
    <div id="allTable" class="table-wrap"></div>
  </section>

  <!-- Debtors -->
  <section id="debtorsSection">
    <h2>Debtors</h2>
    <div class="controls">
      <input id="debtorAddName" placeholder="Debtor name" />
      <input id="debtorAddAmount" type="number" placeholder="Amount" />
      <input id="debtorAddDate" type="date" />
      <button class="btn" id="btnAddDebtor">Add Debtor</button>
      <button class="btn ghost" id="btnBackFromDebtors">Back</button>
    </div>
    <div id="debtorsList" class="table-wrap"></div>
  </section>

  <!-- Creditors -->
  <section id="creditorsSection">
    <h2>Creditors</h2>
    <div class="controls">
      <input id="creditorAddName" placeholder="Creditor name" />
      <input id="creditorAddAmount" type="number" placeholder="Amount" />
      <input id="creditorAddDate" type="date" />
      <button class="btn" id="btnAddCreditor">Add Creditor</button>
      <button class="btn ghost" id="btnBackFromCreditors">Back</button>
    </div>
    <div id="creditorsList" class="table-wrap"></div>
  </section>

  <!-- PDF Remarks -->
  <div style="margin:12px 0;display:flex;gap:8px;align-items:center">
    <label class="small">PDF Remarks:</label>
    <input id="pdfRemarks" placeholder="Type remarks to include in exported PDFs" style="flex:1;padding:8px;border-radius:8px;border:1px solid #e2e8f0" />
  </div>

</div><!-- /container -->

<!-- Edit modal -->
<div class="modal-backdrop" id="modalBackdrop">
  <div class="modal" role="dialog" aria-modal="true" id="editModal">
    <h3>Edit Transaction</h3>
    <div style="display:flex;flex-direction:column;gap:8px;margin-top:8px">
      <input id="modalName" placeholder="Account name" />
      <input id="modalAmount" type="number" placeholder="Amount" />
      <select id="modalPayment"><option>Cash</option><option>Bank</option><option>eSewa</option></select>
      <select id="modalCategory"><option>Income</option><option>Expense</option></select>
      <input id="modalDate" type="date" />
      <input id="modalDesc" placeholder="Description" />
      <div style="display:flex;gap:8px;justify-content:flex-end">
        <button class="btn" id="modalSaveBtn">Save</button>
        <button class="btn ghost" id="modalCancelBtn">Cancel</button>
      </div>
    </div>
  </div>
</div>


<script>
// ============ Firebase config ============
const firebaseConfig = {
  apiKey: "AIzaSyDEwEKdRLKBbsw9GS_V3j0tzRlv4XjOHaA",
  authDomain: "personaldashboard-a6738.firebaseapp.com",
  databaseURL: "https://personaldashboard-a6738-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "personaldashboard-a6738",
  storageBucket: "personaldashboard-a6738.firebasestorage.app",
  messagingSenderId: "936129174674",
  appId: "1:936129174674:web:71dcc2cb9c590a3f361a4b",
  measurementId: "G-85JJGPJ7K4"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// ============ State ============
let TRANSACTIONS = {};
let DEBTORS = {};
let CREDITORS = {};
let editingId = null;
let currentLedgerAccount = '';

// ============ Helpers ============
function esc(s){ return String(s||'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }
function isoToday(){ return new Date().toISOString().slice(0,10); }
function formatNumber(n){ return Number(n||0).toFixed(2); }

// ============ Navigation (dashboard stays) ============
function showSectionKeepDashboard(sectionId){
  document.querySelectorAll('section').forEach(s => s.style.display = 'none');
  if(sectionId){ document.getElementById(sectionId).style.display = 'block'; window.scrollTo({top: 0, behavior:'smooth'}); }
}

// dashboard click (delegation for icon/text)
document.getElementById('dashboard').addEventListener('click', e => {
  const tile = e.target.closest('.tile');
  if(!tile) return;
  const target = tile.dataset.target;
  if(!target) return;
  showSectionKeepDashboard(target);

  if(target === 'ledgerSection') populateLedgerAccounts();
  if(target === 'journalSection') renderJournal();
  if(target === 'allSection') renderAllTransactions();
  if(target === 'debtorsSection') renderDebtors();
  if(target === 'creditorsSection') renderCreditors();
});

// back buttons
['btnBackFromAdd','btnBackFromLedger','btnBackFromJournal','btnBackFromAll','btnBackFromDebtors','btnBackFromCreditors'].forEach(id=>{
  document.getElementById(id).addEventListener('click', ()=> showSectionKeepDashboard(null));
});

// download / delete all tiles
document.getElementById('downloadAllPdfTile').addEventListener('click', ()=> downloadAllTransactionsPDF());
document.getElementById('deleteAllTile').addEventListener('click', ()=> deleteAllData());

// ============ Realtime listeners ============
db.ref('transactions').on('value', snap => { TRANSACTIONS = snap.val() || {}; updateAllViews(); });
db.ref('debtors').on('value', snap => { DEBTORS = snap.val() || {}; renderDebtors(); });
db.ref('creditors').on('value', snap => { CREDITORS = snap.val() || {}; renderCreditors(); });

// ============ Auto-suggest datalist ============
function updateNameDatalist(){
  const dl = document.getElementById('namesDL'); dl.innerHTML = '';
  const names = Object.values(TRANSACTIONS).map(t => t.name); const unique = [...new Set(names)].sort();
  unique.forEach(n => { const opt = document.createElement('option'); opt.value = n; dl.appendChild(opt); });
}

// ============ Add Transaction ============
document.getElementById('btnSaveTx').addEventListener('click', () => {
  const name = (document.getElementById('inputName').value||'').trim();
  const amount = Number(document.getElementById('inputAmount').value || 0);
  const payment = document.getElementById('inputPayment').value;
  const category = document.getElementById('inputCategory').value;
  const date = document.getElementById('inputDate').value || isoToday();
  const desc = (document.getElementById('inputDesc').value||'').trim();
  if(!name || !amount) return alert('Please enter name and amount');
  const ref = db.ref('transactions').push();
  ref.set({ id: ref.key, name, amount, payment, category, date, desc })
    .then(()=>{ 
      document.getElementById('inputName').value=''; 
      document.getElementById('inputAmount').value=''; 
      document.getElementById('inputDate').value=''; 
      document.getElementById('inputDesc').value=''; 
      showSectionKeepDashboard('journalSection'); 
    })
    .catch(e=> alert('Save failed: '+e.message));
});

// ============ Edit modal handling ============
const modalBackdrop = document.getElementById('modalBackdrop');
const modalSaveBtn = document.getElementById('modalSaveBtn');
const modalCancelBtn = document.getElementById('modalCancelBtn');

function openEditModal(id){
  const t = TRANSACTIONS[id]; if(!t) return alert('Transaction not found');
  editingId = id;
  document.getElementById('modalName').value = t.name;
  document.getElementById('modalAmount').value = t.amount;
  document.getElementById('modalPayment').value = t.payment;
  document.getElementById('modalCategory').value = t.category;
  document.getElementById('modalDate').value = t.date || isoToday();
  document.getElementById('modalDesc').value = t.desc || '';
  modalBackdrop.style.display = 'flex';
}

modalCancelBtn.addEventListener('click', ()=> { modalBackdrop.style.display = 'none'; editingId = null; });
modalBackdrop.addEventListener('click', e => { if(e.target===modalBackdrop){ modalBackdrop.style.display='none'; editingId=null; } });

modalSaveBtn.addEventListener('click', ()=>{
  if(!editingId) return;
  const payload = {
    name: (document.getElementById('modalName').value||'').trim(),
    amount: Number(document.getElementById('modalAmount').value || 0),
    payment: document.getElementById('modalPayment').value,
    category: document.getElementById('modalCategory').value,
    date: document.getElementById('modalDate').value || isoToday(),
    desc: (document.getElementById('modalDesc').value||'').trim()
  };
  if(!payload.name || !payload.amount) return alert('Name and amount required');
  db.ref('transactions/' + editingId).update(payload)
    .then(()=>{
      modalBackdrop.style.display='none';
      editingId=null;
      updateAllViews(); // instant refresh all views including ledger
    })
    .catch(e=> alert('Update failed: '+e.message));
});

// ============ Delete transaction ============
function deleteTransaction(id){
  if(!confirm('Delete this transaction?')) return;
  db.ref('transactions/' + id).remove()
    .then(()=> updateAllViews())
    .catch(e=> alert('Delete failed: '+e.message));
}

// ============ Renderers ============
function updateAllViews(){
  updateNameDatalist();
  renderJournal();
  renderAllTransactions();
  populateLedgerAccounts();
  updateBalances();
  renderDebtors();
  renderCreditors();
  if(currentLedgerAccount) renderLedger(currentLedgerAccount); // refresh ledger running balance instantly
}

// ====== Journal & All Transactions ======
function renderJournal(){
  const q = (document.getElementById('journalSearch')?.value || '').toLowerCase();
  const rows = Object.values(TRANSACTIONS).filter(t=> !q || (t.name||'').toLowerCase().includes(q) || (t.desc||'').toLowerCase().includes(q)).sort((a,b)=> new Date(b.date)-new Date(a.date));
  const wrap = document.getElementById('journalTable');
  if(rows.length===0){ wrap.innerHTML='<div class="small">No transactions</div>'; return; }
  let html=`<table><thead><tr><th>Date</th><th>Account</th><th>Description</th><th style="text-align:right">Amount</th><th>Category</th><th>Payment</th><th>Action</th></tr></thead><tbody>`;
  rows.forEach(r => {
    html += `<tr><td>${esc(r.date)}</td><td>${esc(r.name)}</td><td>${esc(r.desc)}</td><td style="text-align:right">${formatNumber(r.amount)}</td><td>${esc(r.category)}</td><td>${esc(r.payment)}</td><td class="actions"><button class="edit" onclick="openEditModal('${r.id}')">Edit</button><button class="del" onclick="deleteTransaction('${r.id}')">Delete</button></td></tr>`;
  });
  html+='</tbody></table>'; wrap.innerHTML=html;
}

function renderAllTransactions(){
  const q = (document.getElementById('allSearch')?.value || '').toLowerCase();
  const dateFilter = document.getElementById('allDate')?.value;
  const rows = Object.values(TRANSACTIONS).filter(t=>{
    if(q && !(t.name||'').toLowerCase().includes(q) && !(t.desc||'').toLowerCase().includes(q)) return false;
    if(dateFilter && t.date!==dateFilter) return false;
    return true;
  }).sort((a,b)=> new Date(b.date)-new Date(a.date));
  const wrap = document.getElementById('allTable');
  if(rows.length===0){ wrap.innerHTML='<div class="small">No transactions</div>'; return; }
  let running=0; let html=`<table><thead><tr><th>Date</th><th>Account</th><th>Description</th><th style="text-align:right">Amount</th><th>Category</th><th>Payment</th><th style="text-align:right">Running</th><th>Action</th></tr></thead><tbody>`;
  rows.forEach(r=>{
    const amt = r.category==='Income'? Number(r.amount): -Number(r.amount);
    running+=amt;
    html+=`<tr><td>${esc(r.date)}</td><td>${esc(r.name)}</td><td>${esc(r.desc)}</td><td style="text-align:right">${formatNumber(r.amount)}</td><td>${esc(r.category)}</td><td>${esc(r.payment)}</td><td style="text-align:right">${formatNumber(running)}</td><td class="actions"><button class="edit" onclick="openEditModal('${r.id}')">Edit</button><button class="del" onclick="deleteTransaction('${r.id}')">Delete</button></td></tr>`;
  });
  html+='</tbody></table>'; wrap.innerHTML=html;
}

// ============ Ledger ============
function populateLedgerAccounts(){
  const select = document.getElementById('ledgerAccount'); select.innerHTML='<option value="">-- Select account --</option>';
  const accounts = [...new Set(Object.values(TRANSACTIONS).map(t=>t.name))].sort();
  accounts.forEach(a=>{ const opt=document.createElement('option'); opt.value=a; opt.textContent=a; select.appendChild(opt); });
}

document.getElementById('btnOpenLedger').addEventListener('click', ()=>{
  const account = document.getElementById('ledgerAccount').value;
  if(!account) return alert('Select an account');
  currentLedgerAccount = account;
  renderLedger(account);
  showSectionKeepDashboard('ledgerSection');
});

function renderLedger(account){
  const dateFilter = document.getElementById('ledgerDate').value;
  const rows = Object.values(TRANSACTIONS).filter(t=> t.name===account && (!dateFilter || t.date===dateFilter)).sort((a,b)=> new Date(a.date)-new Date(b.date));
  const wrap = document.getElementById('ledgerContent');
  if(rows.length===0){ wrap.innerHTML='<div class="small">No transactions for this account</div>'; return; }
  let running=0; let html=`<table><thead><tr><th>Date</th><th>Description</th><th style="text-align:right">Amount</th><th>Category</th><th>Payment</th><th style="text-align:right">Running</th><th>Action</th></tr></thead><tbody>`;
  rows.forEach(r=>{
    const amt = r.category==='Income'? Number(r.amount): -Number(r.amount);
    running+=amt;
    html+=`<tr><td>${esc(r.date)}</td><td>${esc(r.desc)}</td><td style="text-align:right">${formatNumber(r.amount)}</td><td>${esc(r.category)}</td><td>${esc(r.payment)}</td><td style="text-align:right">${formatNumber(running)}</td><td class="actions"><button class="edit" onclick="openEditModal('${r.id}')">Edit</button><button class="del" onclick="deleteTransaction('${r.id}')">Delete</button></td></tr>`;
  });
  html+='</tbody></table>'; wrap.innerHTML=html;
}

// ============ Debtors / Creditors ============
function renderDebtors(){
  const wrap = document.getElementById('debtorsTable');
  const rows = Object.values(DEBTORS);
  if(rows.length===0){ wrap.innerHTML='<div class="small">No debtors</div>'; return; }
  let html=`<table><thead><tr><th>Name</th><th style="text-align:right">Amount</th></tr></thead><tbody>`;
  rows.forEach(r=> html+=`<tr><td>${esc(r.name)}</td><td style="text-align:right">${formatNumber(r.amount)}</td></tr>`); html+='</tbody></table>'; wrap.innerHTML=html;
}

function renderCreditors(){
  const wrap = document.getElementById('creditorsTable');
  const rows = Object.values(CREDITORS);
  if(rows.length===0){ wrap.innerHTML='<div class="small">No creditors</div>'; return; }
  let html=`<table><thead><tr><th>Name</th><th style="text-align:right">Amount</th></tr></thead><tbody>`;
  rows.forEach(r=> html+=`<tr><td>${esc(r.name)}</td><td style="text-align:right">${formatNumber(r.amount)}</td></tr>`); html+='</tbody></table>'; wrap.innerHTML=html;
}

// ============ Balances ============
function updateBalances(){
  const totalIncome = Object.values(TRANSACTIONS).filter(t=>t.category==='Income').reduce((a,b)=>a+Number(b.amount),0);
  const totalExpense = Object.values(TRANSACTIONS).filter(t=>t.category!=='Income').reduce((a,b)=>a+Number(b.amount),0);
  document.getElementById('balanceIncome').textContent = formatNumber(totalIncome);
  document.getElementById('balanceExpense').textContent = formatNumber(totalExpense);
  document.getElementById('balanceNet').textContent = formatNumber(totalIncome-totalExpense);
}

// ============ Delete All ============
function deleteAllData(){
  if(!confirm('Delete ALL transactions?')) return;
  db.ref('transactions').remove().then(()=> updateAllViews()).catch(e=> alert('Delete all failed: '+e.message));
}

// ============ Initial UI ============
showSectionKeepDashboard(null);
updateAllViews();
</script>

</body>
</html>
